<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Visualizer â€“ ToneJS MIDI + MusicXML (lokal, ohne Audio)</title>

  <!-- Import the MIDI parser as an ES module and expose it globally -->
  <script type="module">
    import { Midi } from './tonejs-midi.js';
    window.ToneMidi = Midi; // now you can new ToneMidi(arrayBuffer) anywhere
  </script>

  <!-- Local copies to avoid CDN/ORB issues -->
  <script defer src="./opensheetmusicdisplay.min.js"></script>
  <script defer src="./all-around-keyboard.min.js"></script>

  <style>
    :root { --c1:#2f6fab; --c2:#f5f7fb; --c3:#222; --c4:#d7dbe4; }
    * { box-sizing: border-box; }
    body{font-family:system-ui,Arial,sans-serif;background:var(--c2);color:var(--c3);margin:0;padding:24px}
    h1{margin:0 0 12px;color:var(--c1)}
    .card{background:#fff;border:1px solid var(--c4);border-radius:12px;padding:16px;max-width:1000px;margin:0 auto}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:10px 0}
    label{font-size:.95rem}
    input[type="range"]{width:220px}
    button{padding:8px 12px;border-radius:8px;border:1px solid var(--c4);background:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    #roll{width:100%;height:200px;border:1px solid var(--c4);border-radius:10px;background:#fff;margin:10px 0}
    all-around-keyboard{width:100%;height:170px;display:block;border:1px solid var(--c4);border-radius:10px}
    #osmd{background:#fff;border:1px solid var(--c4);border-radius:10px;padding:10px;margin-top:16px;overflow:auto}
    #status{font:12px/1.4 ui-monospace,monospace;background:#fff;border:1px solid #e0e4ee;border-radius:8px;padding:8px;white-space:pre-wrap;max-height:140px;overflow:auto}
    .small{font-size:.9rem;color:#555}
  </style>
</head>
<body>
  <h1>ðŸŽ¹ Visualizer â€“ MIDI â†’ Piano-Roll & Leucht-Keyboard + MusicXML</h1>
  <div class="card">
    <div class="row">
      <label><strong>MIDI laden:</strong> <input id="midiFile" type="file" accept=".mid,.midi"></label>
      <label><strong>MusicXML laden:</strong> <input id="xmlFile" type="file" accept=".musicxml,.xml,.mxl"></label>
    </div>

    <div class="row">
      <button id="play" disabled>Play</button>
      <button id="stop" disabled>Stop</button>
      <label><input id="loop" type="checkbox"> Loop</label>
      <label><strong>Tempo:</strong> <span id="bpmVal">100</span> BPM</label>
      <input id="bpm" type="range" min="50" max="160" step="1" value="100">
    </div>

    <canvas id="roll"></canvas>
    <all-around-keyboard id="kb" octaves="2" width="900" depth="120"></all-around-keyboard>

    <div id="osmd"><p class="small">Lade eine MusicXML-Datei, um die Notenschrift zu sehen.</p></div>

    <h3>Status</h3>
    <div id="status"></div>
  </div>

  <script>
  // simple logger
  const log = (...a)=>{ const el=document.getElementById('status'); el.textContent += a.join(' ') + '\n'; el.scrollTop=el.scrollHeight; };

  document.addEventListener('DOMContentLoaded', () => {
    // UI refs
    const midiInput = document.getElementById('midiFile');
    const xmlInput  = document.getElementById('xmlFile');
    const playBtn   = document.getElementById('play');
    const stopBtn   = document.getElementById('stop');
    const loopCb    = document.getElementById('loop');
    const bpm       = document.getElementById('bpm');
    const bpmVal    = document.getElementById('bpmVal');
    const kb        = document.getElementById('kb');
    const rollCv    = document.getElementById('roll');
    const ctx       = rollCv.getContext('2d');

    // Keyboard range
    const LOWEST_PITCH = 60; // C4
    const OCTAVES = parseInt(kb.getAttribute('octaves')) || 2;
    const TOTAL_KEYS = 12 * OCTAVES;
    const toIdx = p => p - LOWEST_PITCH;

    // Playback (visuals only)
    let notes=[], total=0;
    let playing=false, startedAt=0, t0=0, rafId=null, lastLit=new Set();

    // Draw piano-roll
    function drawRoll(){
      const pad=6, W=rollCv.clientWidth, H=rollCv.clientHeight;
      if (rollCv.width!==W || rollCv.height!==H){ rollCv.width=W; rollCv.height=H; }
      ctx.clearRect(0,0,W,H); ctx.fillStyle='#f3f5fb'; ctx.fillRect(0,0,W,H);
      if (!notes.length || total<=0) return;
      const secToX=s=>pad+(W-2*pad)*(s/total), keyH=(H-2*pad)/TOTAL_KEYS;
      ctx.fillStyle='#2f6fab';
      for (const n of notes){
        const i=toIdx(n.p); if (i<0 || i>=TOTAL_KEYS) continue;
        const x=secToX(n.s), w=Math.max(2, secToX(n.e)-secToX(n.s)), y=H-pad-(i+1)*keyH;
        ctx.fillRect(x,y,w,keyH-1);
      }
    }
    function drawPlayhead(t){
      if (total<=0) return;
      const pad=6, x=pad+(rollCv.width-2*pad)*(Math.min(t,total)/total);
      ctx.strokeStyle='#e74c3c'; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,rollCv.height); ctx.stroke();
    }

    // MIDI loader using @tonejs/midi
    async function loadMidi(file){
      try {
        if (!window.ToneMidi) throw new Error('ToneJS MIDI (tonejs-midi.js) nicht geladen.');
        const buf = await file.arrayBuffer();
        const midi = new window.ToneMidi(buf);

        // Collect notes from all tracks
        notes = [];
        for (const tr of midi.tracks) {
          for (const n of tr.notes) {
            notes.push({ p: n.midi, s: n.time, e: n.time + n.duration });
          }
        }
        notes.sort((a,b)=>a.s-b.s);
        total = notes.length ? Math.max(...notes.map(n => n.e)) : 0;
        t0 = 0;

        drawRoll(); dimAll();
        playBtn.disabled = notes.length === 0;
        stopBtn.disabled = notes.length === 0;
        log('MIDI geladen:', file.name, `| Noten: ${notes.length} | Dauer: ${total.toFixed(2)}s`);
      } catch (err) {
        console.error(err); log('MIDI-Fehler:', err?.message || err);
        alert('MIDI konnte nicht geladen werden. Exportiere als â€žStandard MIDI (Format 1)â€œ und versuche es erneut.\n\nDetails: ' + (err?.message || err));
      }
    }

    // MusicXML loader via OSMD
    let osmd=null;
    async function loadXML(file){
      try{
        if (!osmd) osmd=new opensheetmusicdisplay.OpenSheetMusicDisplay('osmd',{ drawingParameters:'compact' });
        const ext=file.name.toLowerCase().split('.').pop();
        if (ext==='mxl'){ await osmd.load(await file.arrayBuffer()); }
        else { await osmd.load(await file.text()); }
        await osmd.render();
        log('MusicXML geladen:', file.name);
      } catch (err) {
        console.error(err); log('OSMD Fehler:', err?.message || err);
        alert('Konnte MusicXML nicht laden (braucht <score-partwise> / <score-timewise>).');
      }
    }

    // Keyboard lights
    function dimAll(){ kb.keysDim(Array.from({length:TOTAL_KEYS},(_,i)=>i)); lastLit.clear(); }
    function updateLights(t){
      const on=new Set();
      for (const n of notes){ if (t>=n.s && t<n.e){ const i=toIdx(n.p); if (i>=0 && i<TOTAL_KEYS) on.add(i); } }
      const light=[], dim=[];
      for (const i of on) if (!lastLit.has(i)) light.push(i);
      for (const i of lastLit) if (!on.has(i)) dim.push(i);
      if (light.length) kb.keysLight(light);
      if (dim.length)   kb.keysDim(dim);
      lastLit=on;
    }

    // Visual transport (tempo + loop)
    const baseBPM=100, getBPM=()=>Number(bpm.value);
    bpm.addEventListener('input', e => bpmVal.textContent = e.target.value);
    bpmVal.textContent = bpm.value;

    const nowTime = () => !playing ? t0 : t0 + (performance.now()/1000 - startedAt) * (getBPM()/baseBPM);

    function tick(){
      const t = nowTime();
      if (loopCb.checked && total>0 && t>=total){ t0=0; startedAt=performance.now()/1000; }
      drawRoll(); drawPlayhead(Math.min(t,total)); updateLights(Math.min(t,total));
      rafId = requestAnimationFrame(tick);
    }
    function start(){ if (!notes.length || playing) return; playing=true; startedAt=performance.now()/1000; rafId=requestAnimationFrame(tick); }
    function stop(){  playing=false; if (rafId) cancelAnimationFrame(rafId); rafId=null; t0=0; dimAll(); drawRoll(); }

    // Wire up UI
    midiInput.addEventListener('change', e => {
      const f=e.target.files[0]; if (!f) return;
      const ext=f.name.toLowerCase().split('.').pop();
      if (ext==='mid' || ext==='midi') loadMidi(f);
      else alert('Bitte eine MIDI-Datei (.mid/.midi) wÃ¤hlen.');
    });
    xmlInput.addEventListener('change', e => {
      const f=e.target.files[0]; if (!f) return;
      const ext=f.name.toLowerCase().split('.').pop();
      if (['xml','musicxml','mxl'].includes(ext)) loadXML(f);
      else alert('Bitte eine MusicXML-Datei (.xml/.musicxml/.mxl) wÃ¤hlen.');
    });
    playBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);

    // Debug info
    setTimeout(()=>log('ToneJS MIDI geladen?', !!window.ToneMidi), 0);
  });
  </script>
</body>
</html>
