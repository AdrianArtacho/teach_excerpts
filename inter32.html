<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Practice Excerpt â€“ Crash-proof</title>

  <!-- Load Tone + Magenta FIRST -->
  <script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js"></script>
  <!-- Then the midi player web component -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-midi-player/1.6.0/midi-player.min.js"></script>
  <!-- Keyboard component (optional, kept) -->
  <script src="https://cdn.jsdelivr.net/gh/micahscopes/all-around-keyboard/dist/all-around-keyboard.min.js"></script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f5f7fb; color:#222; padding:24px; }
    .card { background:#fff; border:1px solid #d7dbe4; border-radius:12px; padding:16px; max-width:980px; }
    .row { display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin:8px 0 12px; }
    input[type="range"]{ width:220px }
    midi-visualizer { width:100%; height:220px; display:block; border:1px solid #d7dbe4; border-radius:10px; background:#fff; margin:10px 0 16px; }
    all-around-keyboard { width:100%; height:170px; display:block; border:1px solid #d7dbe4; border-radius:10px; }
    button { padding:8px 12px; border-radius:8px; border:1px solid #d7dbe4; background:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <h1>ðŸŽ¹ Ãœben â€“ Piano Roll & Leucht-Keyboard</h1>
  <div class="card">
    <div class="row">
      <button id="unlock">Audio starten</button>
      <label><strong>Tempo:</strong> <span id="bpmVal">100</span> BPM</label>
      <input id="bpm" type="range" min="50" max="160" step="1" value="100" />
      <label><input id="loop" type="checkbox"> Ganze Passage wiederholen</label>
    </div>

    <!-- Weâ€™ll create the player/visualizer/keyboard here via JS -->
    <div id="mount"></div>
  </div>

  <script>
    // --- Unlock audio (Chrome autoplay policy)
    document.getElementById('unlock').addEventListener('click', () => {
      if (window.Tone && Tone.context.state !== 'running') Tone.context.resume();
    }, { once:true });

    // Build everything AFTER the custom element is ready (kills the race)
    customElements.whenDefined('midi-player').then(() => {
      const mount = document.getElementById('mount');

      // Create player
      const player = document.createElement('midi-player');
      player.id = 'player';
      player.setAttribute('src', 'excerpt1.mid');
      player.setAttribute('controls', '');

      // Create visualizer and slot it inside the player
      const viz = document.createElement('midi-visualizer');
      viz.setAttribute('type', 'piano-roll');
      viz.setAttribute('slot', 'visualizer');
      player.appendChild(viz);

      // Add to DOM
      mount.appendChild(player);

      // Create keyboard under the player
      const kb = document.createElement('all-around-keyboard');
      kb.id = 'kb';
      kb.setAttribute('octaves', '2');
      kb.setAttribute('width', '900');
      kb.setAttribute('depth', '120');
      mount.appendChild(kb);

      // ---------- Tempo ----------
      const bpm = document.getElementById('bpm');
      const bpmVal = document.getElementById('bpmVal');
      const setBPM = v => { if (window.Tone) Tone.Transport.bpm.value = Number(v); };
      bpm.addEventListener('input', e => { bpmVal.textContent = e.target.value; setBPM(e.target.value); });
      setBPM(bpm.value);

      // ---------- Loop using Transport ----------
      const loopCb = document.getElementById('loop');
      let loopEnd = 0;
      player.addEventListener('load', () => {
        loopEnd = player.noteSequence?.totalTime || 0;
        Tone.Transport.setLoopPoints(0, loopEnd);
        Tone.Transport.loop = loopCb.checked;
      });
      player.addEventListener('play', () => {
        if (loopEnd <= 0 && player.noteSequence) loopEnd = player.noteSequence.totalTime || 0;
        Tone.Transport.setLoopPoints(0, loopEnd);
        Tone.Transport.loop = loopCb.checked;
      });
      loopCb.addEventListener('change', () => {
        if (loopEnd <= 0 && player.noteSequence) loopEnd = player.noteSequence.totalTime || 0;
        Tone.Transport.setLoopPoints(0, loopEnd);
        Tone.Transport.loop = loopCb.checked;
      });
      player.addEventListener('pause', () => { Tone.Transport.loop = false; });
      player.addEventListener('stop',  () => { Tone.Transport.loop = false; Tone.Transport.seconds = 0; });

      // ---------- Lighting keyboard (loop/tempo safe)
      const LOWEST_PITCH = 60; // C4
      const OCTAVES = parseInt(kb.getAttribute('octaves')) || 2;
      const TOTAL_KEYS = 12 * OCTAVES;
      const toIndex = p => p - LOWEST_PITCH;

      let notes = [];
      player.addEventListener('load', () => {
        notes = (player.noteSequence?.notes || []).map(n => ({ p:n.pitch, s:n.startTime, e:n.endTime }));
      });

      let rafId = null;
      let prevIdx = new Set();
      function stopLights() {
        if (rafId) cancelAnimationFrame(rafId);
        rafId = null;
        kb.keysDim(Array.from({length: TOTAL_KEYS}, (_, i) => i));
        prevIdx.clear();
      }
      function startLights() {
        stopLights();
        if (!notes.length) return;
        const tick = () => {
          const t = (typeof player.currentTime === 'number') ? player.currentTime
                  : (window.Tone?.Transport?.seconds || 0);
          const active = new Set();
          for (const n of notes) {
            if (t >= n.s && t < n.e) {
              const idx = toIndex(n.p);
              if (idx >= 0 && idx < TOTAL_KEYS) active.add(idx);
            }
          }
          const toLight = [], toDim = [];
          for (const i of active) if (!prevIdx.has(i)) toLight.push(i);
          for (const i of prevIdx) if (!active.has(i)) toDim.push(i);
          if (toLight.length) kb.keysLight(toLight);
          if (toDim.length)   kb.keysDim(toDim);
          prevIdx = active;
          rafId = requestAnimationFrame(tick);
        };
        rafId = requestAnimationFrame(tick);
      }
      player.addEventListener('play',  startLights);
      player.addEventListener('pause', stopLights);
      player.addEventListener('stop',  stopLights);
      player.addEventListener('load',  () => {
        if (window.Tone?.Transport?.state === 'started') startLights();
      });
    });
  </script>
</body>
</html>
